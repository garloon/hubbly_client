<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:Hubbly.Mobile.ViewModels"
             xmlns:components="clr-namespace:Hubbly.Mobile.Components"
             xmlns:converters="clr-namespace:Hubbly.Mobile.Converters"
             x:Class="Hubbly.Mobile.Views.AvatarSelectionPage"
             x:DataType="viewmodels:AvatarSelectionViewModel"
             Title="{DynamicResource AvatarSelectionTitle}"
             BackgroundColor="{DynamicResource PageBackgroundColor}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:GenderSelectionConverter x:Key="GenderSelectionConverter" />
            <converters:GenderTextColorConverter x:Key="GenderTextColorConverter" />
            <converters:InverseBoolConverter x:Key="InverseBoolConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid>
        <!-- Background Gradient -->
        <BoxView>
            <BoxView.Background>
                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                    <GradientStop Color="{DynamicResource PrimaryColor}" Offset="0.0"/>
                    <GradientStop Color="{DynamicResource SecondaryColor}" Offset="1.0"/>
                </LinearGradientBrush>
            </BoxView.Background>
        </BoxView>

        <!-- Main Content -->
        <ScrollView>
            <Grid x:Name="MainGrid" Padding="{StaticResource SpacingMd}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Page Header -->
                <components:PageHeader Grid.Row="0"
                                       Title="Создание аватара"
                                       ShowMenuButton="False"
                                       ShowActionButton="False"
                                       Margin="0,0,0,16" />

                <!-- Avatar Preview -->
                <Frame Grid.Row="1"
                       BackgroundColor="White"
                       HorizontalOptions="Center"
                       CornerRadius="20"
                       HasShadow="True"
                       Margin="{StaticResource SpacingMd}">
                    <Frame.Content>
                        <Grid WidthRequest="150" HeightRequest="200">
                            <BoxView BackgroundColor="#F1F5F9" CornerRadius="20"/>
                            <Label Text="{Binding AvatarEmoji}"
                                   FontSize="80"
                                   HorizontalOptions="Center"
                                   VerticalOptions="Center" />
                            <Frame BackgroundColor="#4F46E5"
                                   Padding="12,6"
                                   CornerRadius="12"
                                   HasShadow="False"
                                   HorizontalOptions="Center"
                                   VerticalOptions="End"
                                   Margin="0,0,0,15">
                                <Label Text="{Binding GenderText}"
                                       FontSize="13"
                                       FontAttributes="Bold"
                                       TextColor="White" />
                            </Frame>
                        </Grid>
                    </Frame.Content>
                </Frame>

                <!-- Gender Selection -->
                <VerticalStackLayout Grid.Row="2"
                                     Spacing="{StaticResource SpacingSm}"
                                     Margin="{StaticResource SpacingMd}">
                    <Label Text="ВЫБЕРИТЕ ПОЛ"
                           FontSize="13"
                           FontAttributes="Bold"
                           TextColor="{DynamicResource SecondaryTextColor}"
                           Margin="0,0,0,4" />

                    <HorizontalStackLayout Spacing="{StaticResource SpacingMd}"
                                           HorizontalOptions="Center">
                        <!-- Male -->
                        <Frame BackgroundColor="{Binding IsMaleSelected, Converter={StaticResource GenderSelectionConverter}}"
                               WidthRequest="130"
                               HeightRequest="150"
                               Margin="0"
                               CornerRadius="15"
                               HasShadow="True">
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding SelectMaleCommand}" />
                            </Frame.GestureRecognizers>
                            <VerticalStackLayout Spacing="12"
                                                 Padding="25,30"
                                                 HorizontalOptions="Center">
                                <Label Text="♂"
                                       FontSize="40"
                                       HorizontalOptions="Center"
                                       TextColor="{Binding IsMaleSelected, Converter={StaticResource GenderTextColorConverter}}" />
                                <Label Text="МУЖСКОЙ"
                                       FontSize="14"
                                       FontAttributes="Bold"
                                       HorizontalOptions="Center"
                                       TextColor="{Binding IsMaleSelected, Converter={StaticResource GenderTextColorConverter}}" />
                            </VerticalStackLayout>
                        </Frame>

                        <!-- Female -->
                        <Frame BackgroundColor="{Binding IsFemaleSelected, Converter={StaticResource GenderSelectionConverter}}"
                               WidthRequest="130"
                               HeightRequest="150"
                               Margin="0"
                               CornerRadius="15"
                               HasShadow="True">
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding SelectFemaleCommand}" />
                            </Frame.GestureRecognizers>
                            <VerticalStackLayout Spacing="12"
                                                 Padding="25,30"
                                                 HorizontalOptions="Center">
                                <Label Text="♀"
                                       FontSize="40"
                                       HorizontalOptions="Center"
                                       TextColor="{Binding IsFemaleSelected, Converter={StaticResource GenderTextColorConverter}}" />
                                <Label Text="ЖЕНСКИЙ"
                                       FontSize="14"
                                       FontAttributes="Bold"
                                       HorizontalOptions="Center"
                                       TextColor="{Binding IsFemaleSelected, Converter={StaticResource GenderTextColorConverter}}" />
                            </VerticalStackLayout>
                        </Frame>
                    </HorizontalStackLayout>
                </VerticalStackLayout>

                <!-- Continue Button -->
                <VerticalStackLayout Grid.Row="3"
                                     Spacing="{StaticResource SpacingSm}"
                                     Margin="{StaticResource SpacingMd}">
                    <Button Text="ВОЙТИ В ЧАТ"
                            Command="{Binding ConfirmCommand}"
                            HeightRequest="56"
                            FontSize="18"
                            FontAttributes="Bold"
                            Style="{StaticResource PrimaryButtonStyle}"
                            IsEnabled="{Binding IsBusy, Converter={StaticResource InverseBoolConverter}}" />

                    <!-- Loading Indicator -->
                    <ActivityIndicator IsRunning="{Binding IsBusy}"
                                       IsVisible="{Binding IsBusy}"
                                       Color="{DynamicResource PrimaryColor}"
                                       HorizontalOptions="Center" />
                </VerticalStackLayout>

                <!-- Back Button -->
                <Button Grid.Row="4"
                        Text="← Назад"
                        Command="{Binding GoBackCommand}"
                        Style="{StaticResource SecondaryButtonStyle}"
                        Margin="{StaticResource SpacingMd}" />

            </Grid>
        </ScrollView>
    </Grid>
</ContentPage>