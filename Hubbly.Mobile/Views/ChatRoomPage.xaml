<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:converters="clr-namespace:Hubbly.Mobile.Converters"
             x:Class="Hubbly.Mobile.Views.ChatRoomPage"
             Title="Hubbly Chat"
             BackgroundColor="#F8FAFC">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:AvatarColorConverter x:Key="AvatarColorConverter" />
            <converters:InitialsConverter x:Key="InitialsConverter" />
            <converters:InverseBoolConverter x:Key="InverseBoolConverter" />
            <converters:GenderSelectionConverter x:Key="GenderSelectionConverter" />
            <converters:GenderTextColorConverter x:Key="GenderTextColorConverter" />
            <converters:StringNotEmptyConverter x:Key="StringNotEmptyConverter" />
            <converters:IsNotSystemMessageConverter x:Key="IsNotSystemMessageConverter" />
            <converters:IsSystemMessageConverter x:Key="IsSystemMessageConverter" />
            <converters:ContinueButtonColorConverter x:Key="ContinueButtonColorConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <!-- Ð“Ð»Ð°Ð²Ð½Ñ‹Ð¹ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ñ Ð¿Ñ€Ð¾Ð¿Ð¾Ñ€Ñ†Ð¸ÑÐ¼Ð¸ -->
    <Grid RowDefinitions="0.1*,0.25*,0.075*,0.50*,0.075*" 
          ColumnDefinitions="*"
          RowSpacing="0">

        <!-- ==================== 1. Ð¨ÐÐŸÐšÐ (10%) ==================== -->
        <Frame Grid.Row="0"
               BackgroundColor="{DynamicResource CardBackgroundColor}"
               Padding="15,10"
               Margin="0"
               HasShadow="True"
               CornerRadius="0">

            <Grid ColumnDefinitions="Auto,*,Auto">

                <!-- Hamburger Menu Button (ÑÐ»ÐµÐ²Ð°) -->
                <Frame Grid.Column="0"
                       Padding="0"
                       BackgroundColor="Transparent"
                       WidthRequest="40"
                       HeightRequest="40"
                       CornerRadius="20"
                       HasShadow="False"
                       IsClippedToBounds="True">
                    <Button Text="â˜°"
                            FontSize="20"
                            TextColor="{DynamicResource TextColor}"
                            BackgroundColor="Transparent"
                            BorderWidth="0"
                            Command="{Binding ToggleFlyoutCommand}"
                            HorizontalOptions="Center"
                            VerticalOptions="Center" />
                </Frame>

                <!-- ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð¸ ÑÑ‚Ð°Ñ‚ÑƒÑ (Ð¿Ð¾ Ñ†ÐµÐ½Ñ‚Ñ€Ñƒ) -->
                <VerticalStackLayout Grid.Column="1"
                                     Spacing="2"
                                     VerticalOptions="Center">
                    <Label Text="{Binding RoomName}"
                           FontSize="18"
                           FontAttributes="Bold"
                           TextColor="{DynamicResource TextColor}"
                           HorizontalTextAlignment="Center" />

                    <HorizontalStackLayout Spacing="5" HorizontalOptions="Center">
                        <BoxView Color="#10B981"
                                 WidthRequest="6"
                                 HeightRequest="6"
                                 CornerRadius="3"
                                 VerticalOptions="Center"/>

                        <Label Text="{Binding RoomStatus}"
                               FontSize="12"
                               TextColor="{DynamicResource SecondaryTextColor}" />
                    </HorizontalStackLayout>
                </VerticalStackLayout>

                <!-- Placeholder for balance (ÑÐ¿Ñ€Ð°Ð²Ð°) -->
                <Frame Grid.Column="2"
                       Padding="0"
                       BackgroundColor="Transparent"
                       WidthRequest="40"
                       HeightRequest="40"
                       HasShadow="False" />
            </Grid>
        </Frame>

        <!-- ==================== 2. 3D Ð¡Ð¦Ð•ÐÐ (25%) ==================== -->
        <Grid Grid.Row="1"
              BackgroundColor="#0F172A"
              Padding="0">

            <!-- WebView Ñ Three.js (Ð²Ð¸Ð´Ð¸Ð¼ ÐºÐ¾Ð³Ð´Ð° 3D Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½) -->
            <WebView x:Name="AvatarWebView"
                    VerticalOptions="Fill"
                    BackgroundColor="Transparent"
                    IsVisible="{Binding Is3DEnabled}"/>

            <!-- Fallback UI (Ð²Ð¸Ð´Ð¸Ð¼ ÐºÐ¾Ð³Ð´Ð° 3D Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½) -->
            <Grid IsVisible="{Binding Is3DEnabled, Converter={StaticResource InverseBoolConverter}}"
                  BackgroundColor="#1E293B"
                  VerticalOptions="Fill"
                  HorizontalOptions="Fill">

                <VerticalStackLayout HorizontalOptions="Center"
                                     VerticalOptions="Center"
                                     Spacing="20">

                    <Label Text="ðŸŽ­"
                           FontSize="48"
                           TextColor="#94A3B8"/>

                    <Label Text="3D mode unavailable"
                           FontSize="16"
                           TextColor="#94A3B8"
                           HorizontalOptions="Center"/>

                    <!-- Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ Ð² Ð²Ð¸Ð´Ðµ Ð°Ð²Ð°Ñ‚Ð°Ñ€Ð¾Ð² -->
                    <CollectionView ItemsSource="{Binding OnlineAvatars}"
                                   HorizontalOptions="Center"
                                   VerticalOptions="Center"
                                   Margin="0,20,0,0">
                        <CollectionView.ItemsLayout>
                            <LinearItemsLayout Orientation="Horizontal" 
                                             ItemSpacing="15"/>
                        </CollectionView.ItemsLayout>
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <VerticalStackLayout Spacing="5"
                                                   HorizontalOptions="Center">
                                    <Frame BackgroundColor="{Binding Nickname, Converter={StaticResource AvatarColorConverter}}"
                                           WidthRequest="50"
                                           HeightRequest="50"
                                           CornerRadius="25"
                                           Padding="0"
                                           HasShadow="True">
                                        <Label Text="{Binding Nickname, Converter={StaticResource InitialsConverter}}"
                                               TextColor="White"
                                               FontSize="16"
                                               FontAttributes="Bold"
                                               HorizontalOptions="Center"
                                               VerticalOptions="Center"/>
                                    </Frame>
                                    <Label Text="{Binding Nickname}"
                                           FontSize="10"
                                           TextColor="#94A3B8"
                                           HorizontalOptions="Center"/>
                                </VerticalStackLayout>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>
            </Grid>

            <!-- Loading Overlay (Ð²Ð¸Ð´Ð¸Ð¼ ÐºÐ¾Ð³Ð´Ð° ÑÑ†ÐµÐ½Ð° Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑÑ) -->
            <Grid x:Name="LoadingOverlay"
                  IsVisible="False"
                  BackgroundColor="#CC0F172A"
                  VerticalOptions="Fill"
                  HorizontalOptions="Fill">

                <VerticalStackLayout HorizontalOptions="Center"
                                     VerticalOptions="Center"
                                     Spacing="20">

                    <ActivityIndicator IsRunning="True"
                                       Color="#4F46E5"
                                       WidthRequest="60"
                                       HeightRequest="60"/>

                    <Label Text="Loading 3D world..."
                           TextColor="White"
                           FontSize="16"
                           HorizontalOptions="Center"/>
                </VerticalStackLayout>
            </Grid>
        </Grid>

        <!-- ==================== 3. ÐŸÐÐÐ•Ð›Ð¬ ÐŸÐžÐ›Ð¬Ð—ÐžÐ’ÐÐ¢Ð•Ð›Ð¯ (7.5%) ==================== -->
        <Frame Grid.Row="2"
               BackgroundColor="#F1F5F9"
               Padding="10"
               HasShadow="False"
               CornerRadius="0">

            <Grid ColumnDefinitions="*,Auto">

                <!-- Ð¢ÐµÐºÑƒÑ‰Ð¸Ð¹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ (Ð¿Ð¾ Ñ†ÐµÐ½Ñ‚Ñ€Ñƒ) -->
                <Frame Grid.Column="0"
                       BackgroundColor="White"
                       Padding="12,6"
                       CornerRadius="20"
                       HorizontalOptions="Center">
                    <Label Text="{Binding Nickname}"
                           FontSize="15"
                           FontAttributes="Bold"
                           TextColor="#4F46E5"
                           HorizontalOptions="Center"/>
                </Frame>
                
            </Grid>
        </Frame>

        <!-- ==================== 4. ÐžÐ‘Ð›ÐÐ¡Ð¢Ð¬ Ð¡ÐžÐžÐ‘Ð©Ð•ÐÐ˜Ð™ (50%) ==================== -->
        <Grid Grid.Row="3" 
      BackgroundColor="#F8FAFC">

            <!-- ÐŸÐ°Ñ‚Ñ‚ÐµÑ€Ð½ Ñ„Ð¾Ð½Ð° (ÐµÐ»Ðµ Ð·Ð°Ð¼ÐµÑ‚Ð½Ñ‹Ð¹) -->
            <BoxView BackgroundColor="#F1F5F9"
             Opacity="0.3"/>

            <!-- Ð¡Ð¿Ð¸ÑÐ¾Ðº ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ -->
            <ListView x:Name="MessagesListView"
              ItemsSource="{Binding Messages}"
              HasUnevenRows="True"
              SeparatorVisibility="None"
              VerticalScrollBarVisibility="Never"
              BackgroundColor="Transparent"
              Margin="0"
              VerticalOptions="Fill">

                <ListView.ItemTemplate>
                    <DataTemplate>
                        <ViewCell>
                            <VerticalStackLayout Spacing="4">
                                <!-- Ð”ÐžÐ‘ÐÐ’Ð›Ð•Ð Ð ÐžÐ”Ð˜Ð¢Ð•Ð›Ð¬Ð¡ÐšÐ˜Ð™ ÐšÐžÐÐ¢Ð•Ð™ÐÐ•Ð  -->

                                <!-- ========== Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐÐžÐ• Ð¡ÐžÐžÐ‘Ð©Ð•ÐÐ˜Ð• ========== -->
                                <Frame IsVisible="{Binding IsSystemMessage}"
                               BackgroundColor="#FEF3C7"
                               Padding="12,8"
                               HorizontalOptions="Center"
                               CornerRadius="20"
                               Margin="20,8"
                               HasShadow="False">
                                    <HorizontalStackLayout Spacing="8">
                                        <Label Text="âš¡"
                                       FontSize="14"/>
                                        <Label Text="{Binding Content}"
                                       FontSize="13"
                                       TextColor="#92400E"
                                       HorizontalOptions="Center"/>
                                        <Label Text="{Binding SentAt, StringFormat='{0:HH:mm}'}"
                                       FontSize="10"
                                       TextColor="#92400E"
                                       Opacity="0.8"/>
                                    </HorizontalStackLayout>
                                </Frame>

                                <!-- ========== Ð¡ÐžÐžÐ‘Ð©Ð•ÐÐ˜Ð• Ð¢Ð•ÐšÐ£Ð©Ð•Ð“Ðž ÐŸÐžÐ›Ð¬Ð—ÐžÐ’ÐÐ¢Ð•Ð›Ð¯ (Ð¡ÐŸÐ ÐÐ’Ð) ========== -->
                                <Frame IsVisible="{Binding IsCurrentUser}"
                               BackgroundColor="#8B5CF6"
                               Padding="12,8"
                               HorizontalOptions="End"
                               CornerRadius="4"
                               Margin="60,4,12,4"
                               HasShadow="False">
                                    <VerticalStackLayout Spacing="2">
                                        <Label Text="{Binding Content}"
                                       FontSize="15"
                                       TextColor="White"
                                       LineBreakMode="WordWrap"/>
                                        <Label Text="{Binding SentAt, StringFormat='{0:HH:mm}'}"
                                       FontSize="10"
                                       TextColor="#E0E7FF"
                                       HorizontalOptions="End"/>
                                    </VerticalStackLayout>
                                </Frame>

                                <!-- ========== Ð¡ÐžÐžÐ‘Ð©Ð•ÐÐ˜Ð• Ð”Ð Ð£Ð“ÐžÐ“Ðž ÐŸÐžÐ›Ð¬Ð—ÐžÐ’ÐÐ¢Ð•Ð›Ð¯ (Ð¡Ð›Ð•Ð’Ð) ========== -->
                                <Grid IsVisible="{Binding IsOtherUserMessage}"
                                      ColumnDefinitions="Auto, *"
                                      Margin="12,4,60,4">

                                    <!-- ÐÐ²Ð°Ñ‚Ð°Ñ€ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ -->
                                    <Frame Grid.Column="0"
                                   BackgroundColor="{Binding SenderNickname, Converter={StaticResource AvatarColorConverter}}"
                                   Padding="0"
                                   WidthRequest="40"
                                   HeightRequest="40"
                                   CornerRadius="20"
                                   Margin="0,0,8,0"
                                   HasShadow="False">
                                        <Label Text="{Binding SenderNickname, Converter={StaticResource InitialsConverter}}"
                                       FontSize="14"
                                       FontAttributes="Bold"
                                       TextColor="White"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center"/>
                                    </Frame>

                                    <!-- ÐšÐ¾Ð½Ñ‚ÐµÐ½Ñ‚ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ -->
                                    <VerticalStackLayout Grid.Column="1" 
                                                 Spacing="2">

                                        <!-- Ð˜Ð¼Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»Ñ -->
                                        <Label Text="{Binding SenderNickname}"
                                       FontSize="12"
                                       FontAttributes="Bold"
                                       TextColor="#64748B"
                                       Margin="0,0,0,2"/>

                                        <!-- Ð¢ÐµÐºÑÑ‚ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ -->
                                        <Frame BackgroundColor="White"
                                       Padding="12,8"
                                       CornerRadius="4"
                                       HasShadow="False">
                                            <VerticalStackLayout>
                                                <Label Text="{Binding Content}"
                                               FontSize="15"
                                               TextColor="#1E293B"
                                               LineBreakMode="WordWrap"/>
                                                <Label Text="{Binding SentAt, StringFormat='{0:HH:mm}'}"
                                               FontSize="10"
                                               TextColor="#94A3B8"
                                               HorizontalOptions="End"/>
                                            </VerticalStackLayout>
                                        </Frame>
                                    </VerticalStackLayout>
                                </Grid>

                            </VerticalStackLayout>
                            <!-- ÐšÐžÐÐ•Ð¦ Ð ÐžÐ”Ð˜Ð¢Ð•Ð›Ð¬Ð¡ÐšÐžÐ“Ðž ÐšÐžÐÐ¢Ð•Ð™ÐÐ•Ð Ð -->
                        </ViewCell>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>
        </Grid>

        <!-- ==================== 5. ÐŸÐžÐ›Ð• Ð’Ð’ÐžÐ”Ð (7.5%) ==================== -->
        <Frame Grid.Row="4"
               BackgroundColor="White"
               Padding="8"
               HasShadow="True"
               CornerRadius="0">

            <Grid ColumnDefinitions="*,Auto">

                <!-- ÐŸÐ¾Ð»Ðµ Ð²Ð²Ð¾Ð´Ð° -->
                <Frame Grid.Column="0"
                       BackgroundColor="#F1F5F9"
                       Padding="0"
                       HeightRequest="52"
                       CornerRadius="26"
                       Margin="0,0,8,0">

                    <Entry Placeholder="ÐÐ°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ..."
                           PlaceholderColor="#64748B"
                           Text="{Binding MessageText}"
                           ClearButtonVisibility="WhileEditing"
                           FontSize="15"
                           BackgroundColor="Transparent"
                           TextColor="#1E293B"
                           Margin="20,0"
                           VerticalOptions="Center"
                           VerticalTextAlignment="Center"
                           ReturnType="Send"
                           ReturnCommand="{Binding SendMessageCommand}">
                        <Entry.Behaviors>
                            <toolkit:EventToCommandBehavior 
                                        EventName="Completed"
                                        Command="{Binding SendMessageCommand}"/>
                        </Entry.Behaviors>
                    </Entry>
                </Frame>

                <!-- ÐšÐ½Ð¾Ð¿ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ -->
                <Button Grid.Column="1"
                        Text="âž¤"
                        Command="{Binding SendMessageCommand}"
                        WidthRequest="52"
                        HeightRequest="52"
                        CornerRadius="26"
                        BackgroundColor="#4F46E5"
                        TextColor="White"
                        FontSize="20"
                        FontAttributes="Bold"
                        IsEnabled="{Binding MessageText, Converter={StaticResource StringNotEmptyConverter}}"/>
            </Grid>
        </Frame>
    </Grid>
</ContentPage>