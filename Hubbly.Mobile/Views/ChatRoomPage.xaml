<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:converters="clr-namespace:Hubbly.Mobile.Converters"
             xmlns:components="clr-namespace:Hubbly.Mobile.Components"
             xmlns:viewmodels="clr-namespace:Hubbly.Mobile.ViewModels"
             xmlns:models="clr-namespace:Hubbly.Mobile.Models"
             x:Class="Hubbly.Mobile.Views.ChatRoomPage"
             x:DataType="viewmodels:ChatRoomViewModel"
             Title="Hubbly Chat"
             BackgroundColor="{DynamicResource PageBackgroundColor}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- Ð¯Ð²Ð½Ð¾ Ð¾Ð±ÑŠÑÐ²Ð»ÑÐµÐ¼ Ð²ÑÐµ ÐºÐ¾Ð½Ð²ÐµÑ€Ñ‚ÐµÑ€Ñ‹ Ñ ÐºÐ»ÑŽÑ‡Ð°Ð¼Ð¸ -->
            <converters:AvatarColorConverter x:Key="AvatarColorConverter" />
            <converters:InitialsConverter x:Key="InitialsConverter" />
            <converters:InverseBoolConverter x:Key="InverseBoolConverter" />
            <converters:GenderSelectionConverter x:Key="GenderSelectionConverter" />
            <converters:GenderTextColorConverter x:Key="GenderTextColorConverter" />
            <converters:StringNotEmptyConverter x:Key="StringNotEmptyConverter" />
            <converters:IsNotSystemMessageConverter x:Key="IsNotSystemMessageConverter" />
            <converters:IsSystemMessageConverter x:Key="IsSystemMessageConverter" />
            <converters:ContinueButtonColorConverter x:Key="ContinueButtonColorConverter" />
            <converters:OrientationToValueConverter x:Key="OrientationToValueConverter" />
            <converters:IsLandscapeConverter x:Key="IsLandscapeConverter" />
            <converters:ScreenSizeToValueConverter x:Key="ScreenSizeToValueConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <!-- ÐÐ´Ð°Ð¿Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹ Grid Ñ Ð´Ð¸Ð½Ð°Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ð¼Ð¸ Ð¿Ñ€Ð¾Ð¿Ð¾Ñ€Ñ†Ð¸ÑÐ¼Ð¸ -->
    <Grid x:Name="MainGrid" RowDefinitions="Auto,*,Auto,2*,Auto"
          ColumnDefinitions="*"
          RowSpacing="0">

        <!-- ==================== 1. HEADER (PageHeader component) ==================== -->
        <components:PageHeader Grid.Row="0"
                               Title="{Binding RoomName}"
                               ShowMenuButton="True"
                               ToggleFlyoutCommand="{Binding ToggleFlyoutCommand}"
                               ShowActionButton="False" />

        <!-- ==================== 2. 3D SCENE AREA (1 part) ==================== -->
        <Grid Grid.Row="1"
              ColumnDefinitions="*"
              BackgroundColor="{DynamicResource SceneBackgroundColor}">

            <!-- WebView Ñ Three.js (Ð²Ð¸Ð´Ð¸Ð¼ ÐºÐ¾Ð³Ð´Ð° 3D Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½) -->
            <WebView x:Name="AvatarWebView"
                     VerticalOptions="Fill"
                     HorizontalOptions="Fill"
                     BackgroundColor="Transparent"
                     IsVisible="{Binding Is3DEnabled}" />

            <!-- Fallback UI (Ð²Ð¸Ð´Ð¸Ð¼ ÐºÐ¾Ð³Ð´Ð° 3D Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½) -->
            <Grid IsVisible="{Binding Is3DEnabled, Converter={StaticResource InverseBoolConverter}}"
                  BackgroundColor="{DynamicResource CardBackgroundColor}"
                  VerticalOptions="Fill"
                  HorizontalOptions="Fill"
                  Padding="{StaticResource SpacingMd}">

                <VerticalStackLayout HorizontalOptions="Center"
                                     VerticalOptions="Center"
                                     Spacing="{StaticResource SpacingLg}">

                    <!-- Online Avatars -->
                    <Label Text="Online Users"
                           FontSize="16"
                           FontAttributes="Bold"
                           TextColor="{DynamicResource SecondaryTextColor}"
                           HorizontalOptions="Center" />

                    <CollectionView ItemsSource="{Binding OnlineAvatars}"
                                    HorizontalOptions="Center"
                                    VerticalOptions="Center"
                                    HeightRequest="200"
                                    ItemsLayout="HorizontalList"
                                    ItemSizingStrategy="MeasureAllItems">

                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:AvatarPresence">
                                <components:AvatarView Nickname="{Binding Nickname}"
                                                       AvatarColor="{DynamicResource PrimaryColor}"
                                                       Size="Medium"
                                                       ShowOnlineStatus="True"
                                                       IsOnline="True"
                                                       Margin="8" />
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <!-- Placeholder text -->
                    <Label Text="3D mode unavailable"
                           FontSize="14"
                           TextColor="{DynamicResource SecondaryTextColor}"
                           HorizontalOptions="Center"
                           Opacity="0.7" />
                </VerticalStackLayout>
            </Grid>

            <!-- Loading Overlay -->
            <Grid x:Name="LoadingOverlay"
                  IsVisible="False"
                  BackgroundColor="#80000000"
                  VerticalOptions="Fill"
                  HorizontalOptions="Fill">

                <VerticalStackLayout HorizontalOptions="Center"
                                     VerticalOptions="Center"
                                     Spacing="{StaticResource SpacingMd}">

                    <ActivityIndicator IsRunning="True"
                                       Color="{DynamicResource PrimaryColor}"
                                       WidthRequest="60"
                                       HeightRequest="60" />

                    <Label Text="Loading 3D world..."
                           TextColor="White"
                           FontSize="16"
                           HorizontalOptions="Center" />
                </VerticalStackLayout>
            </Grid>
        </Grid>

        <!-- ==================== 2.5. CONTROL PANEL ==================== -->
        <Grid Grid.Row="2"
              ColumnDefinitions="Auto,*,Auto,Auto"
              VerticalOptions="Center"
              Padding="16,8"
              BackgroundColor="{DynamicResource CardBackgroundColor}"
              IsVisible="{Binding IsControlPanelVisible}">
            
            <!-- Navigate Left Button -->
            <Button x:Name="BtnNavigateLeft"
                    Grid.Column="0"
                    Text="â—„"
                    Command="{Binding NavigateLeftCommand}"
                    IsEnabled="{Binding CanNavigateLeft}"
                    WidthRequest="50"
                    HeightRequest="50"
                    FontSize="24"
                    BackgroundColor="{DynamicResource PrimaryColor}"
                    TextColor="White"
                    CornerRadius="25"
                    Margin="8,0"
                    VerticalOptions="Center">
                <!-- ÐÐ½Ð¸Ð¼Ð°Ñ†Ð¸Ð¸ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ ÑƒÐ´Ð°Ð»ÐµÐ½Ñ‹ Ð´Ð»Ñ ÑÐ±Ð¾Ñ€ÐºÐ¸ -->
            </Button>

            <!-- Nickname Display -->
            <Label Grid.Column="1"
                   Text="{Binding SelectedAvatar.Nickname}"
                   FontSize="18"
                   FontAttributes="Bold"
                   TextColor="{DynamicResource TextColor}"
                   HorizontalOptions="Center"
                   VerticalOptions="Center">
                <Label.Triggers>
                    <DataTrigger TargetType="Label" Binding="{Binding SelectedAvatar.IsCurrentUser}" Value="True">
                        <Setter Property="TextColor" Value="{DynamicResource PrimaryColor}" />
                    </DataTrigger>
                </Label.Triggers>
            </Label>

            <!-- Navigate Right Button -->
            <Button x:Name="BtnNavigateRight"
                    Grid.Column="2"
                    Text="â–º"
                    Command="{Binding NavigateRightCommand}"
                    IsEnabled="{Binding CanNavigateRight}"
                    WidthRequest="50"
                    HeightRequest="50"
                    FontSize="24"
                    BackgroundColor="{DynamicResource PrimaryColor}"
                    TextColor="White"
                    CornerRadius="25"
                    Margin="8,0"
                    VerticalOptions="Center">
                <!-- ÐÐ½Ð¸Ð¼Ð°Ñ†Ð¸Ð¸ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ ÑƒÐ´Ð°Ð»ÐµÐ½Ñ‹ Ð´Ð»Ñ ÑÐ±Ð¾Ñ€ÐºÐ¸ -->
            </Button>

            <!-- Context Menu Button -->
            <Button x:Name="BtnContextMenu"
                    Grid.Column="3"
                    Text="â‹®"
                    Command="{Binding ShowContextMenuCommand}"
                    WidthRequest="50"
                    HeightRequest="50"
                    FontSize="24"
                    BackgroundColor="{DynamicResource SecondaryColor}"
                    TextColor="White"
                    CornerRadius="25"
                    Margin="8,0"
                    VerticalOptions="Center">
                <!-- ÐÐ½Ð¸Ð¼Ð°Ñ†Ð¸Ð¸ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ ÑƒÐ´Ð°Ð»ÐµÐ½Ñ‹ Ð´Ð»Ñ ÑÐ±Ð¾Ñ€ÐºÐ¸ -->
            </Button>
        </Grid>

        <!-- ==================== 3. CHAT MESSAGES AREA (2 parts) ==================== -->
        <Grid Grid.Row="3"
              BackgroundColor="{DynamicResource PageBackgroundColor}"
              RowSpacing="0">

            <!-- Chat Messages CollectionView -->
            <CollectionView x:Name="MessagesCollectionView"
                            ItemsSource="{Binding Messages}"
                            VerticalOptions="Fill"
                            HorizontalOptions="Fill"
                            BackgroundColor="Transparent"
                            VerticalScrollBarVisibility="Always"
                            HorizontalScrollBarVisibility="Never">

                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:ChatMessage">
                        <Grid Padding="12,6"
                              Margin="0,2"
                              BackgroundColor="Transparent">

                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <!-- Avatar -->
                            <components:AvatarView Grid.Column="0"
                                                   Nickname="{Binding SenderNickname}"
                                                   AvatarColor="{Binding SenderNickname, Converter={StaticResource AvatarColorConverter}}"
                                                   Size="Small"
                                                   ShowOnlineStatus="False"
                                                   IsOnline="True"
                                                   Margin="0,0,8,0"
                                                   VerticalOptions="Start"/>

                            <!-- Message Content -->
                            <Grid Grid.Column="1"
                                  RowDefinitions="Auto,Auto"
                                  RowSpacing="2">

                                <!-- Sender Name & Time -->
                                <Grid Grid.Row="0"
                                      ColumnDefinitions="*,Auto"
                                      VerticalOptions="Center">
                                    <Label Text="{Binding SenderNickname}"
                                           FontSize="12"
                                           FontAttributes="Bold"
                                           TextColor="{DynamicResource TextColor}"
                                           VerticalOptions="Center"/>
                                    <Label Grid.Column="1"
                                           Text="{Binding SentAt, StringFormat='{0:HH:mm}'}"
                                           FontSize="11"
                                           TextColor="{DynamicResource SecondaryTextColor}"
                                           VerticalOptions="Center"/>
                                </Grid>

                                <!-- Message Text -->
                                <Label Grid.Row="1"
                                       Text="{Binding Content}"
                                       FontSize="14"
                                       TextColor="{DynamicResource TextColor}"
                                       LineBreakMode="WordWrap"
                                       VerticalOptions="Start"/>
                            </Grid>
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>

                <!-- Empty View when no messages -->
                <CollectionView.EmptyView>
                    <StackLayout VerticalOptions="Center"
                                 HorizontalOptions="Center"
                                 Spacing="12">
                        <Label Text="ðŸ’¬"
                               FontSize="48"
                               HorizontalOptions="Center"
                               Opacity="0.5"/>
                        <Label Text="No messages yet"
                               FontSize="16"
                               TextColor="{DynamicResource SecondaryTextColor}"
                               HorizontalOptions="Center"/>
                    </StackLayout>
                </CollectionView.EmptyView>
            </CollectionView>
        </Grid>

        <!-- ==================== 4. INPUT AREA ==================== -->
        <Frame Grid.Row="4"
               BackgroundColor="{DynamicResource CardBackgroundColor}"
               Padding="12,8"
               HasShadow="True"
               CornerRadius="0"
               Margin="0">

            <Grid ColumnDefinitions="*,Auto"
                  ColumnSpacing="8">

                <!-- Message Input -->
                <Frame Grid.Column="0"
                       BackgroundColor="{DynamicResource InputBackgroundColor}"
                       Padding="0"
                       HeightRequest="48"
                       CornerRadius="24"
                       Margin="0,0,8,0"
                       HasShadow="False">

                    <Grid ColumnDefinitions="Auto,*">
                        <!-- User Avatar (small) -->
                        <components:AvatarView Grid.Column="0"
                                               Nickname="{Binding Nickname}"
                                               AvatarColor="{DynamicResource PrimaryColor}"
                                               Size="Small"
                                               ShowOnlineStatus="False"
                                               VerticalOptions="Center"
                                               Margin="8,0,4,0" />

                        <!-- Entry -->
                        <Entry Grid.Column="1"
                               Placeholder="ÐÐ°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ..."
                               PlaceholderColor="#64748B"
                               Text="{Binding MessageText}"
                               ClearButtonVisibility="WhileEditing"
                               FontSize="15"
                               BackgroundColor="Transparent"
                               TextColor="{DynamicResource TextColor}"
                               VerticalOptions="Center"
                               VerticalTextAlignment="Center"
                               ReturnType="Send"
                               ReturnCommand="{Binding SendMessageCommand}">
                            <Entry.Behaviors>
                                <toolkit:EventToCommandBehavior
                                    EventName="Completed"
                                    Command="{Binding SendMessageCommand}" />
                            </Entry.Behaviors>
                        </Entry>
                    </Grid>
                </Frame>

                <!-- Send Button -->
                <Button Grid.Column="1"
                        Text="âž¤"
                        Command="{Binding SendMessageCommand}"
                        WidthRequest="48"
                        HeightRequest="48"
                        CornerRadius="24"
                        BackgroundColor="{DynamicResource PrimaryColor}"
                        TextColor="White"
                        FontSize="20"
                        FontAttributes="Bold"
                        IsEnabled="{Binding MessageText, Converter={StaticResource StringNotEmptyConverter}}"
                        Style="{StaticResource PrimaryButtonStyle}" />
            </Grid>
        </Frame>
    </Grid>
</ContentPage>